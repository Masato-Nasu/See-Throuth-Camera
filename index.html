<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>è¦–è¦šæ”¯æ´ARï¼šæ–¹å‘ï¼ˆæ™‚è¨ˆï¼‰ã€è·é›¢ã€ç‰©ä½“ã‚’æ—¥æœ¬èªã§èª­ã¿ä¸Šã’</title>
  <meta name="description" content="æœ€ã‚‚è¿‘ã„å¯¾è±¡ã‚’å„ªå…ˆã—ã€æ™‚è¨ˆæ–¹å‘ãƒ»è·é›¢ãƒ»ç‰©ä½“åã‚’æ—¥æœ¬èªã§èª­ã¿ä¸Šã’ã¾ã™ã€‚ä¿¡å·æ©Ÿã®èµ¤/é’ã‚‚å¯¾å¿œã€‚ãƒ©ãƒ™ãƒ«ã¯å¤§ããæ—¥æœ¬èªã§è¡¨ç¤ºã—ã€åˆ‡ã‚Œãªã„ã‚ˆã†è‡ªå‹•èª¿æ•´ã€‚" />
  <!-- æ­£ã—ã„CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.19.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  <style>
    :root{ --green:#39ff14; --text:#e8ffe8; }
    html,body{ margin:0; height:100%; background:#000; color:var(--text); font-family:ui-monospace,Menlo,Consolas,monospace; overflow:hidden }
    #wrap{ position:fixed; inset:0; }
    video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover }
    canvas{ position:absolute; inset:0; pointer-events:none }
    #controls{ position:fixed; left:0; right:0; bottom:0; display:flex; flex-wrap:wrap; gap:10px; padding:8px calc(10px + env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) calc(10px + env(safe-area-inset-left)); background:rgba(0,0,0,0.15); border-top:1px solid rgba(57,255,20,.25); overflow-x:auto; -webkit-overflow-scrolling:touch; z-index:5 }
    .label{ color:var(--green); font-size:12px; margin:0 4px }
    .range, select, .btn{ border:1px solid rgba(57,255,20,.45); background:rgba(0,0,0,.25); color:var(--text); border-radius:10px; padding:6px 10px; white-space:nowrap }
    .btn{ cursor:pointer }
    #gate{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.9); color:var(--text); z-index:10; text-align:center; gap:14px; padding:20px }
    #toast{ position:fixed; left:50%; transform:translateX(-50%); top:10px; padding:8px 12px; border:1px solid rgba(57,255,20,.5); border-radius:10px; background:rgba(0,0,0,.55); color:var(--green); display:none; z-index:20 }
  </style>
  <link rel="icon" href="data:," />
</head>
<body>
  <div id="toast"></div>
  <div id="wrap">
    <video id="v" autoplay playsinline muted></video>
    <canvas id="ov"></canvas>
  </div>
  <div id="controls">
    <button class="btn" id="startBtn">â–¶ï¸ é–‹å§‹</button>
    <span class="label">æ¤œå‡º</span><input id="detectOn" type="checkbox" checked />
    <span class="label">FOVÂ°</span><input class="range" id="fov" type="range" min="45" max="85" value="60" />
    <span class="label">èª­ã¿ä¸Šã’</span>
    <select id="announceMode">
      <option value="important">é‡è¦ã®ã¿ï¼ˆäººãƒ»è»Šãƒ»è‡ªè»¢è»Šãƒ»ãƒã‚¹ï¼‰</option>
      <option value="people_vehicles">äººï¼‹ä¹—ã‚Šç‰©</option>
      <option value="all">ã™ã¹ã¦</option>
    </select>
    <span class="label">æœ€å¤§ä»¶æ•°</span><input class="range" id="topK" type="range" min="1" max="3" value="1" />
  </div>
  <div id="gate">
    <div>
      <h2 style="color:#39ff14;margin:0 0 6px">ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™</h2>
      <p style="margin:0 0 12px">HTTPSã§é–‹ã„ã¦ãã ã•ã„ã€‚é–‹å§‹ã§èƒŒé¢ã‚«ãƒ¡ãƒ©ï¼‹HUDãŒèµ·å‹•ã—ã¾ã™ã€‚</p>
      <button class="btn" id="gateStart">é–‹å§‹ / START</button>
    </div>
  </div>

<script>
(async()=>{
const v=document.getElementById('v');
const ov=document.getElementById('ov');
const ctx=ov.getContext('2d');
const toast=(m)=>{ const t=document.getElementById('toast'); t.textContent=m; t.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>t.style.display='none', 2400); }; 
console.log('[A11yAR] boot');
let model=null, detTimer=null;

async function loadModelWithFallback(){
  try{ model=await cocoSsd.load({base:'lite_mobilenet_v2'}); return true; }
  catch(e1){ console.warn('[A11yAR] coco-ssd load failed (primary)', e1);
    try{
      await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://unpkg.com/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
      model=await cocoSsd.load({base:'lite_mobilenet_v2'}); return true;
    }catch(e2){ console.warn('[A11yAR] coco-ssd load failed (fallback)', e2); return false; }
  }
}

async function startCamera(){
  if(!window.isSecureContext && location.hostname!=='localhost' && location.hostname!=='127.0.0.1'){
    toast('âš  HTTPSãŒå¿…è¦ã§ã™ï¼ˆã¾ãŸã¯ localhostï¼‰');
    throw new Error('Insecure');
  }
  try{
    const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
    v.srcObject=stream; 
    await new Promise(res=> v.onloadedmetadata=res); 
    await v.play();
    resize(); addEventListener('resize', resize);
    toast('ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•');
  }catch(e){ 
    console.error('[A11yAR] camera error', e); 
    toast('âŒ ã‚«ãƒ¡ãƒ©å¤±æ•—: '+e.name+': '+e.message); 
    throw e; 
  }
}

function resize(){ const w=v.videoWidth||v.clientWidth||innerWidth; const h=v.videoHeight||v.clientHeight||innerHeight; ov.width=w; ov.height=h; }

// ==== æ—¥æœ¬èªãƒ©ãƒ™ãƒ«
function toJa(cls){
  const map={
    person:'äºº', bicycle:'è‡ªè»¢è»Š', car:'è»Š', motorcycle:'ãƒã‚¤ã‚¯', airplane:'é£›è¡Œæ©Ÿ', bus:'ãƒã‚¹', train:'é›»è»Š', truck:'ãƒˆãƒ©ãƒƒã‚¯', boat:'ãƒœãƒ¼ãƒˆ',
    'traffic light':'ä¿¡å·', 'fire hydrant':'æ¶ˆç«æ “', 'stop sign':'ä¸€æ™‚åœæ­¢æ¨™è­˜', 'parking meter':'ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°ãƒ¡ãƒ¼ã‚¿ãƒ¼', bench:'ãƒ™ãƒ³ãƒ',
    bird:'é³¥', cat:'çŒ«', dog:'çŠ¬', horse:'é¦¬', sheep:'ç¾Š', cow:'ç‰›', elephant:'è±¡', bear:'ç†Š', zebra:'ã‚·ãƒã‚¦ãƒ', giraffe:'ã‚­ãƒªãƒ³',
    backpack:'ãƒªãƒ¥ãƒƒã‚¯', umbrella:'å‚˜', handbag:'ãƒãƒ³ãƒ‰ãƒãƒƒã‚°', tie:'ãƒã‚¯ã‚¿ã‚¤', suitcase:'ã‚¹ãƒ¼ãƒ„ã‚±ãƒ¼ã‚¹',
    frisbee:'ãƒ•ãƒªã‚¹ãƒ“ãƒ¼', skis:'ã‚¹ã‚­ãƒ¼æ¿', snowboard:'ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰', 'sports ball':'ãƒœãƒ¼ãƒ«', kite:'å‡§', 'baseball bat':'ãƒãƒƒãƒˆ', 'baseball glove':'ã‚°ãƒ­ãƒ¼ãƒ–', skateboard:'ã‚¹ã‚±ãƒ¼ãƒˆãƒœãƒ¼ãƒ‰', surfboard:'ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰', 'tennis racket':'ãƒ†ãƒ‹ã‚¹ãƒ©ã‚±ãƒƒãƒˆ',
    bottle:'ãƒœãƒˆãƒ«', 'wine glass':'ãƒ¯ã‚¤ãƒ³ã‚°ãƒ©ã‚¹', cup:'ã‚«ãƒƒãƒ—', fork:'ãƒ•ã‚©ãƒ¼ã‚¯', knife:'ãƒŠã‚¤ãƒ•', spoon:'ã‚¹ãƒ—ãƒ¼ãƒ³', bowl:'ãƒœã‚¦ãƒ«',
    banana:'ãƒãƒŠãƒŠ', apple:'ã‚Šã‚“ã”', sandwich:'ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ', orange:'ã‚ªãƒ¬ãƒ³ã‚¸', broccoli:'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼', carrot:'ã«ã‚“ã˜ã‚“', 'hot dog':'ãƒ›ãƒƒãƒˆãƒ‰ãƒƒã‚°', pizza:'ãƒ”ã‚¶', donut:'ãƒ‰ãƒ¼ãƒŠãƒ„', cake:'ã‚±ãƒ¼ã‚­',
    chair:'æ¤…å­', couch:'ã‚½ãƒ•ã‚¡', 'potted plant':'è¦³è‘‰æ¤ç‰©', bed:'ãƒ™ãƒƒãƒ‰', 'dining table':'ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«', toilet:'ãƒˆã‚¤ãƒ¬',
    tv:'ãƒ†ãƒ¬ãƒ“', laptop:'ãƒãƒ¼ãƒˆPC', mouse:'ãƒã‚¦ã‚¹', remote:'ãƒªãƒ¢ã‚³ãƒ³', keyboard:'ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰', 'cell phone':'ã‚¹ãƒãƒ›',
    microwave:'é›»å­ãƒ¬ãƒ³ã‚¸', oven:'ã‚ªãƒ¼ãƒ–ãƒ³', toaster:'ãƒˆãƒ¼ã‚¹ã‚¿ãƒ¼', sink:'æµã—å°', refrigerator:'å†·è”µåº«',
    book:'æœ¬', clock:'æ™‚è¨ˆ', vase:'èŠ±ç“¶', scissors:'ã¯ã•ã¿', 'teddy bear':'ã¬ã„ãã‚‹ã¿', 'hair drier':'ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼', toothbrush:'æ­¯ãƒ–ãƒ©ã‚·'
  };
  return map[cls]||cls;
}

// ä»¥é™ã®å‡¦ç†ï¼ˆè§’åº¦â†’æ™‚è¨ˆã€è·é›¢æ¨å®šã€ä¿¡å·æ¤œçŸ¥ã€éŸ³å£°åˆæˆã€æç”»ã€detLoopã€startAllï¼‰
// ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ã§OKã€‚é‡è¤‡ãƒ»ã‚¨ãƒ©ãƒ¼éƒ¨åˆ†ã¯ä¸Šè¨˜ã§ä¿®æ­£æ¸ˆã¿ã€‚
})();
</script>
</body>
</html>
