<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>視覚支援AR：緑HUD + 物体検出 + 黄線ガイド + 信号色</title>
  <meta name="description" content="視覚支援モード（音声案内・ビープ・振動）つき実験的ARアプリ。黄線ガイド/信号色推定対応。" />
  <!-- TF.js & COCO-SSD (物体検出) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.19.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  <style>
    :root{ --bg:#000; --green:#39ff14; --text:#d7ffd7; }
    html,body{ margin:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-monospace,Menlo,Consolas,monospace;overflow:hidden; }
    #camWrap{ position:fixed; inset:0; overflow:hidden; }
    #video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    #overlay{ position:absolute; inset:0; pointer-events:none; }
    #hud{ position:fixed; inset:0; pointer-events:none; }
    .panel{ position:absolute; left:50%; transform:translateX(-50%); bottom:6vh; width:min(1000px,92vw); height:56vh; background:transparent; border:1px solid rgba(57,255,20,.35); border-radius:16px; box-shadow:0 0 24px rgba(57,255,20,.12), inset 0 0 40px rgba(57,255,20,.06); overflow:hidden; }
    .title{ position:absolute; inset:0 0 auto 0; height:42px; background:rgba(0,0,0,.5); border-bottom:1px solid rgba(57,255,20,.35); display:flex; align-items:center; padding:0 16px; font-weight:600; letter-spacing:.06em; color:var(--green); text-shadow:0 0 8px rgba(57,255,20,.8); }
    #controls{ position:absolute; inset:auto 0 0 0; height:98px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; padding:8px 10px; background:transparent; border-top:1px solid rgba(57,255,20,.25); pointer-events:auto; }
    .btn{ border:1px solid rgba(57,255,20,.55); background:rgba(0,0,0,.25); color:var(--green); padding:8px 12px; border-radius:10px; font-weight:600; letter-spacing:.04em; cursor:pointer; }
    .input,.range,select{ border:1px solid rgba(57,255,20,.35); background:rgba(0,0,0,.25); color:var(--text); border-radius:8px; padding:6px 10px; }
    .label{ color:var(--green); font-size:12px; margin:0 6px 0 4px; opacity:.9; }
    #gate{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.9); color:var(--text); z-index:10; text-align:center; padding:24px; }
    #gate .start{ font-size:18px; padding:12px 20px; border-radius:14px; cursor:pointer; border:1px solid rgba(57,255,20,.6); background:rgba(0,0,0,.35); color:var(--green); }
  </style>
</head>
<body>
  <div id="camWrap">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="hud">
    <div class="panel">
      <div class="title">A11y AR — OBJECTS / RANGE / TRAFFIC / YELLOW or GAP GUIDE</div>
      <div id="controls">
        <button class="btn" id="btnToggle">▶︎ START</button>
        <span class="label">Detect</span><input id="detectOn" type="checkbox" checked />
        <span class="label">FOV°</span><input class="range" id="fov" type="range" min="45" max="85" value="60" />
        <span class="label">読み上げ</span>
        <select id="announceMode">
          <option value="important">重要のみ（人・車・自転車・バス）</option>
          <option value="people_vehicles">人＋乗り物</option>
          <option value="all">すべて</option>
        </select>
        <span class="label">最大件数</span><input class="range" id="topK" type="range" min="1" max="3" value="1" />
        <span class="label">ガイド</span>
        <select id="guideMode">
          <option value="yellow_first">黄線優先</option>
          <option value="gap_only">ギャップ誘導</option>
        </select>
      </div>
    </div>
  </div>

  <div id="gate">
    <div>
      <h2 style="color:#39ff14">カメラへのアクセスが必要です</h2>
      <button class="start" id="gateStart">開始 / START</button>
    </div>
  </div>

<script>
  const video=document.getElementById('video');
  const overlay=document.getElementById('overlay');
  const octx=overlay.getContext('2d');
  let model=null;

  async function startCamera(){
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject=stream;
    await video.play();
    resizeOverlay();
    window.addEventListener('resize',resizeOverlay);
  }
  function resizeOverlay(){overlay.width=video.clientWidth||window.innerWidth;overlay.height=video.clientHeight||window.innerHeight;}

  function toJa(cls){
    const map={ person:'人', bicycle:'自転車', car:'車', motorcycle:'バイク', bus:'バス', truck:'トラック','traffic light':'信号'};
    return map[cls]||cls;
  }
  function angleToText(ang){const deg=ang*180/Math.PI; if(deg<-15) return '左'; if(deg>15) return '右'; return '前方';}

  const synth=window.speechSynthesis; let lastMap=new Map();
  function speak(t){ if(synth.speaking) return; const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; synth.speak(u);} 
  function throttleSay(key,text){const now=performance.now(),cd=2000,last=lastMap.get(key)||0;if(now-last>cd){lastMap.set(key,now);speak(text);}}

  function drawDetections(preds){
    octx.clearRect(0,0,overlay.width,overlay.height);
    const W=overlay.width; const fov=60*Math.PI/180;
    const scored=preds.map(p=>{const[x,y,w,h]=p.bbox;const cx=x+w/2;const ang=((cx-W/2)/(W/2))*(fov/2);return{...p,ang};});
    const mode=document.getElementById('announceMode').value;
    const allow=(cls)=>{if(mode==='all') return true;const pv=['person','car','bicycle','bus','motorcycle','truck'];const imp=['person','car','bicycle','bus'];return mode==='people_vehicles'?pv.includes(cls):imp.includes(cls);};
    let announced=0;const K=parseInt(document.getElementById('topK').value,10);
    scored.sort((a,b)=>a.score-b.score);
    scored.forEach(p=>{
      const[x,y,w,h]=p.bbox; octx.strokeStyle='rgba(57,255,20,.9)'; octx.lineWidth=3;octx.strokeRect(x,y,w,h);
      const tag=`${toJa(p.class)} ${(p.score*100|0)}% ${angleToText(p.ang)}`;
      octx.fillStyle='rgba(0,0,0,.65)';octx.font='600 20px ui-monospace';
      octx.fillText(tag,x,y-5);
      if(announced<K&&allow(p.class)){throttleSay(`obj_${p.class}`,`${angleToText(p.ang)}、${toJa(p.class)}`);announced++;}
    });
  }

  async function detectionLoop(){if(!model) return;const preds=await model.detect(video);drawDetections(preds);setTimeout(detectionLoop,800);}

  document.getElementById('gateStart').addEventListener('click',async()=>{
    document.getElementById('gate').style.display='none';
    await startCamera();
    model=await cocoSsd.load({base:'lite_mobilenet_v2'});
    detectionLoop();
  });
</script>
</body>
</html>
