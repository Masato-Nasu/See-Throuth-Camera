<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>è¦–è¦šæ”¯æ´ARï¼šæ–¹å‘ï¼ˆæ™‚è¨ˆï¼‰ã€è·é›¢ã€ç‰©ä½“ã‚’æ—¥æœ¬èªã§èª­ã¿ä¸Šã’</title>
  <meta name="description" content="æœ€ã‚‚è¿‘ã„å¯¾è±¡ã‚’å„ªå…ˆã—ã€æ™‚è¨ˆæ–¹å‘ãƒ»è·é›¢ãƒ»ç‰©ä½“åã‚’æ—¥æœ¬èªã§èª­ã¿ä¸Šã’ã¾ã™ã€‚ä¿¡å·æ©Ÿã®èµ¤/é’ã‚‚å¯¾å¿œã€‚ãƒ©ãƒ™ãƒ«ã¯å¤§ããæ—¥æœ¬èªã§è¡¨ç¤ºã—ã€åˆ‡ã‚Œãªã„ã‚ˆã†è‡ªå‹•èª¿æ•´ã€‚" />
  <!-- æ­£ã—ã„CDNï¼ˆä½™è¨ˆãªã‚¤ãƒ³ãƒ©ã‚¤ãƒ³JSã‚’æ··ãœãªã„ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.19.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  <style>
    :root{ --green:#39ff14; --text:#e8ffe8; }
    html,body{ margin:0; height:100%; background:#000; color:var(--text); font-family:ui-monospace,Menlo,Consolas,monospace; overflow:hidden }
    #wrap{ position:fixed; inset:0; }
    video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover }
    canvas{ position:absolute; inset:0; pointer-events:none }
    #controls{ position:fixed; left:0; right:0; bottom:0; display:flex; flex-wrap:wrap; gap:10px; padding:8px calc(10px + env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) calc(10px + env(safe-area-inset-left)); background:rgba(0,0,0,0.15); border-top:1px solid rgba(57,255,20,.25); overflow-x:auto; -webkit-overflow-scrolling:touch; z-index:5 }
    .label{ color:var(--green); font-size:12px; margin:0 4px }
    .range, select, .btn{ border:1px solid rgba(57,255,20,.45); background:rgba(0,0,0,.25); color:var(--text); border-radius:10px; padding:6px 10px; white-space:nowrap }
    .btn{ cursor:pointer }
    #gate{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.9); color:var(--text); z-index:10; text-align:center; gap:14px; padding:20px }
    #toast{ position:fixed; left:50%; transform:translateX(-50%); top:10px; padding:8px 12px; border:1px solid rgba(57,255,20,.5); border-radius:10px; background:rgba(0,0,0,.55); color:var(--green); display:none; z-index:20 }
  </style>
<link rel="icon" href="data:," />
</head>
<body>
  <div id="toast"></div>
  <div id="wrap">
    <video id="v" autoplay playsinline muted></video>
    <canvas id="ov"></canvas>
  </div>
  <div id="controls">
    <button class="btn" id="startBtn">â–¶ï¸ é–‹å§‹</button>
    <span class="label">æ¤œå‡º</span><input id="detectOn" type="checkbox" checked />
    <span class="label">FOVÂ°</span><input class="range" id="fov" type="range" min="45" max="85" value="60" />
    <span class="label">èª­ã¿ä¸Šã’</span>
    <select id="announceMode">
      <option value="important">é‡è¦ã®ã¿ï¼ˆäººãƒ»è»Šãƒ»è‡ªè»¢è»Šãƒ»ãƒã‚¹ï¼‰</option>
      <option value="people_vehicles">äººï¼‹ä¹—ã‚Šç‰©</option>
      <option value="all">ã™ã¹ã¦</option>
    </select>
    <span class="label">æœ€å¤§ä»¶æ•°</span><input class="range" id="topK" type="range" min="1" max="3" value="1" />
  </div>
  <div id="gate">
    <div>
      <h2 style="color:#39ff14;margin:0 0 6px">ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™</h2>
      <p style="margin:0 0 12px">HTTPSã§é–‹ã„ã¦ãã ã•ã„ã€‚é–‹å§‹ã§èƒŒé¢ã‚«ãƒ¡ãƒ©ï¼‹HUDãŒèµ·å‹•ã—ã¾ã™ã€‚</p>
      <button class="btn" id="gateStart">é–‹å§‹ / START</button>
    </div>
  </div>

<script type="module">
const v=document.getElementById('v');
const ov=document.getElementById('ov');
const ctx=ov.getContext('2d');
const toast=(m)=>{ const t=document.getElementById('toast'); t.textContent=m; t.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>t.style.display='none', 2400); }; console.log('[A11yAR] boot');
let model=null, detTimer=null;
async function loadModelWithFallback(){
  try{ model=await cocoSsd.load({base:'lite_mobilenet_v2'}); return true; }
  catch(e1){ console.warn('[A11yAR] coco-ssd load failed (primary)', e1);
    try{
      await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://unpkg.com/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
      model=await cocoSsd.load({base:'lite_mobilenet_v2'}); return true;
    }catch(e2){ console.warn('[A11yAR] coco-ssd load failed (fallback)', e2); return false; }
  }
}

async function startCamera(){
  if(!window.isSecureContext && location.hostname!=='localhost' && location.hostname!=='127.0.0.1'){
    toast('âš  HTTPSãŒå¿…è¦ã§ã™ï¼ˆã¾ãŸã¯ localhostï¼‰');
    throw new Error('Insecure');
  }
  try{
    const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
    v.srcObject=stream; await new Promise(res=> v.onloadedmetadata=res); await v.play();
    resize(); addEventListener('resize', resize);
    toast('ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•');
  }catch(e){ console.error('[A11yAR] camera error', e); toast('âŒ ã‚«ãƒ¡ãƒ©å¤±æ•—: '+e.name+': '+e.message); throw e; }
}{
  if(!window.isSecureContext){ toast('âš  HTTPSãŒå¿…è¦ã§ã™'); throw new Error('Insecure'); }
  const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
  v.srcObject=stream; await new Promise(res=> v.onloadedmetadata=res); await v.play(); resize(); addEventListener('resize', resize); toast('ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•');
}
function resize(){ const w=v.videoWidth||v.clientWidth||innerWidth; const h=v.videoHeight||v.clientHeight||innerHeight; ov.width=w; ov.height=h; }

// ==== æ—¥æœ¬èªãƒ©ãƒ™ãƒ«
function toJa(cls){
  const map={
    // ç”Ÿæ´»å…¨èˆ¬ï¼ˆCOCO-SSD å…¨ã‚¯ãƒ©ã‚¹å¯¾å¿œï¼‰
    person:'äºº', bicycle:'è‡ªè»¢è»Š', car:'è»Š', motorcycle:'ãƒã‚¤ã‚¯', airplane:'é£›è¡Œæ©Ÿ', bus:'ãƒã‚¹', train:'é›»è»Š', truck:'ãƒˆãƒ©ãƒƒã‚¯', boat:'ãƒœãƒ¼ãƒˆ',
    'traffic light':'ä¿¡å·', 'fire hydrant':'æ¶ˆç«æ “', 'stop sign':'ä¸€æ™‚åœæ­¢æ¨™è­˜', 'parking meter':'ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°ãƒ¡ãƒ¼ã‚¿ãƒ¼', bench:'ãƒ™ãƒ³ãƒ',
    bird:'é³¥', cat:'çŒ«', dog:'çŠ¬', horse:'é¦¬', sheep:'ç¾Š', cow:'ç‰›', elephant:'è±¡', bear:'ç†Š', zebra:'ã‚·ãƒã‚¦ãƒ', giraffe:'ã‚­ãƒªãƒ³',
    backpack:'ãƒªãƒ¥ãƒƒã‚¯', umbrella:'å‚˜', handbag:'ãƒãƒ³ãƒ‰ãƒãƒƒã‚°', tie:'ãƒã‚¯ã‚¿ã‚¤', suitcase:'ã‚¹ãƒ¼ãƒ„ã‚±ãƒ¼ã‚¹',
    frisbee:'ãƒ•ãƒªã‚¹ãƒ“ãƒ¼', skis:'ã‚¹ã‚­ãƒ¼æ¿', snowboard:'ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰', 'sports ball':'ãƒœãƒ¼ãƒ«', kite:'å‡§', 'baseball bat':'ãƒãƒƒãƒˆ', 'baseball glove':'ã‚°ãƒ­ãƒ¼ãƒ–', skateboard:'ã‚¹ã‚±ãƒ¼ãƒˆãƒœãƒ¼ãƒ‰', surfboard:'ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰', 'tennis racket':'ãƒ†ãƒ‹ã‚¹ãƒ©ã‚±ãƒƒãƒˆ',
    bottle:'ãƒœãƒˆãƒ«', 'wine glass':'ãƒ¯ã‚¤ãƒ³ã‚°ãƒ©ã‚¹', cup:'ã‚«ãƒƒãƒ—', fork:'ãƒ•ã‚©ãƒ¼ã‚¯', knife:'ãƒŠã‚¤ãƒ•', spoon:'ã‚¹ãƒ—ãƒ¼ãƒ³', bowl:'ãƒœã‚¦ãƒ«',
    banana:'ãƒãƒŠãƒŠ', apple:'ã‚Šã‚“ã”', sandwich:'ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ', orange:'ã‚ªãƒ¬ãƒ³ã‚¸', broccoli:'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼', carrot:'ã«ã‚“ã˜ã‚“', 'hot dog':'ãƒ›ãƒƒãƒˆãƒ‰ãƒƒã‚°', pizza:'ãƒ”ã‚¶', donut:'ãƒ‰ãƒ¼ãƒŠãƒ„', cake:'ã‚±ãƒ¼ã‚­',
    chair:'æ¤…å­', couch:'ã‚½ãƒ•ã‚¡', 'potted plant':'è¦³è‘‰æ¤ç‰©', bed:'ãƒ™ãƒƒãƒ‰', 'dining table':'ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«', toilet:'ãƒˆã‚¤ãƒ¬',
    tv:'ãƒ†ãƒ¬ãƒ“', laptop:'ãƒãƒ¼ãƒˆPC', mouse:'ãƒã‚¦ã‚¹', remote:'ãƒªãƒ¢ã‚³ãƒ³', keyboard:'ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰', 'cell phone':'ã‚¹ãƒãƒ›',
    microwave:'é›»å­ãƒ¬ãƒ³ã‚¸', oven:'ã‚ªãƒ¼ãƒ–ãƒ³', toaster:'ãƒˆãƒ¼ã‚¹ã‚¿ãƒ¼', sink:'æµã—å°', refrigerator:'å†·è”µåº«',
    book:'æœ¬', clock:'æ™‚è¨ˆ', vase:'èŠ±ç“¶', scissors:'ã¯ã•ã¿', 'teddy bear':'ã¬ã„ãã‚‹ã¿', 'hair drier':'ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼', toothbrush:'æ­¯ãƒ–ãƒ©ã‚·'
  };
  return map[cls]||cls;
}; return map[cls]||cls; }

// ==== æ™‚è¨ˆæ–¹å‘ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ12æ™‚=æ­£é¢ã€å³å›ã‚Šï¼‰
function angleToClock(ang){ // ang: ãƒ©ã‚¸ã‚¢ãƒ³ï¼ˆå·¦è² /å³æ­£ï¼‰
  const deg = ang*180/Math.PI; // æƒ³å®šç¯„å›²: ç´„ -90Â°..+90Â°
  const off = Math.round(deg/30); // 30Â°ã§1æ™‚é–“
  let hour = (12 + off)%12; if(hour===0) hour=12; return hour+'æ™‚æ–¹å‘';
}

// ==== è·é›¢æ¨å®šï¼ˆå˜çœ¼è¿‘ä¼¼ï¼‰
const TYPICAL_H={ person:1.7, bicycle:1.05, car:1.45, bus:3.0, truck:2.5, motorcycle:1.2, dog:0.5, cat:0.26, chair:0.9, bottle:0.25, cup:0.1, laptop:0.3, 'traffic light':0.6, 'wine glass':0.18 };
function focalPx(w,fovDeg){ const f=fovDeg*Math.PI/180; return (0.5*w)/Math.tan(f/2); }
function estimateDistPx(bbox, cls){ const h=bbox[3]; const H=TYPICAL_H[cls]||0.3; if(h<=1) return null; const W=(v.videoWidth||ov.width); const F=focalPx(W, parseInt(document.getElementById('fov').value,10)); return (H*F)/h; }

// ==== ä¿¡å·ã®è‰²ï¼ˆèµ¤/ç·‘ï¼‰
function hsvFromRgb(r,g,b){ r/=255; g/=255; b/=255; const M=Math.max(r,g,b), m=Math.min(r,g,b); let h=0,s=0,v=M, d=M-m; s=M===0?0:d/M; if(M!==m){ switch(M){ case r:h=(g-b)/d+(g<b?6:0);break; case g:h=(b-r)/d+2;break; case b:h=(r-g)/d+4; } h/=6; } return {h:h*360,s,v}; }
function redOrGreen(imgData){ const d=imgData.data; let rc=0,gc=0; for(let i=0;i<d.length;i+=4){ const h=hsvFromRgb(d[i],d[i+1],d[i+2]); if(h.v<0.2||h.s<0.35) continue; if(h.h<25||h.h>335) rc++; else if(h.h>75&&h.h<170) gc++; } if(rc+gc<50) return null; return rc>gc?'red':'green'; }

// ==== éŸ³å£°ï¼ˆå‰²è¾¼ã¿ç„¡ã—ãƒ»ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰
const synth=window.speechSynthesis; const lastMap=new Map();
function speak(t){ if(synth.speaking) return; const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; u.rate=1; synth.speak(u); }
function sayThrottle(key, text, cd=1600){ const now=performance.now(), last=lastMap.get(key)||0; if(now-last>cd){ lastMap.set(key, now); speak(text); } }

function drawDetections(preds){
  ctx.clearRect(0,0,ov.width,ov.height);
  const Wpx=(v.videoWidth||ov.width); const fov=parseInt(document.getElementById('fov').value,10)*Math.PI/180;
  const K=parseInt(document.getElementById('topK').value,10)||1;
  const mode=document.getElementById('announceMode').value;
  const allow=(cls)=>{ if(mode==='all') return true; const pv=['person','car','bicycle','bus','motorcycle','truck']; const imp=['person','car','bicycle','bus']; return mode==='people_vehicles'? pv.includes(cls) : imp.includes(cls); };

  const minScore=0.55;
  const items = preds.filter(p=>p.score>=minScore).map(p=>{ const [x,y,w,h]=p.bbox; const cx=x+w/2; const ang=((cx-Wpx/2)/(Wpx/2))*(fov/2); const dist=estimateDistPx(p.bbox,p.class); return {...p, ang, dist}; });
  // è¿‘ã„é † + åŒè·é›¢ãªã‚‰ã‚¹ã‚³ã‚¢é«˜ã„é †
  items.sort((a,b)=>{ const da=a.dist??1e9, db=b.dist??1e9; if(da!==db) return da-db; return b.score-a.score; });

  let said=0;
  items.forEach(p=>{
    const [x,y,w,h]=p.bbox;
    // ãƒ©ãƒ™ãƒ«ä½ç½®ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã«ã‚¯ãƒ©ãƒ³ãƒ—ï¼ˆåˆ‡ã‚Œãªã„ã‚ˆã†ã«ï¼‰
    const tagDir=angleToClock(p.ang); const dtxt = p.dist? ` ${p.dist.toFixed(1)}m` : '';
    const tagText = `${tagDir} ${toJa(p.class)}${dtxt}`;
    ctx.font='600 22px ui-monospace,Menlo,Consolas,monospace';
    const textW=ctx.measureText(tagText).width+16; const padH=28;
    let lx = Math.min(Math.max(x, 4), ov.width - textW - 4);
    let ly = (y>=32)? y-4 : y+h+padH+4; // ä¸Šã«ç½®ã‘ãªã‘ã‚Œã°ä¸‹ã«
    if(ly+(-padH) < 0) ly = y+h+padH+4; // ãã‚Œã§ã‚‚ç„¡ç†ãªã‚‰ä¸‹

    // æ 
    ctx.strokeStyle='rgba(57,255,20,.95)'; ctx.lineWidth=3; ctx.strokeRect(x,y,w,h);
    // æ—¥æœ¬èªãƒ»å¤§ãã‚ãƒ©ãƒ™ãƒ«ï¼ˆæ™‚è¨ˆæ–¹å‘ï¼‹ç‰©ä½“ï¼‹è·é›¢ï¼‰
    ctx.fillStyle='rgba(0,0,0,.7)'; ctx.fillRect(lx, ly-padH, textW, padH);
    ctx.fillStyle='#39ff14'; ctx.fillText(tagText, lx+8, ly-7);

    // ä¿¡å·èª­ã¿ä¸Šã’ï¼ˆèµ¤/é’ï¼‹è·é›¢ï¼‹æ™‚è¨ˆæ–¹å‘ï¼‰
    if(p.class==='traffic light'){
      try{ const crop=ctx.getImageData(x,y,w,h); const col=redOrGreen(crop); if(col){ const msg = col==='red'? 'ä¿¡å·ã¯èµ¤ã§ã™ã€‚æ­¢ã¾ã£ã¦ãã ã•ã„ã€‚' : 'ä¿¡å·ã¯é’ã§ã™ã€‚æ¸¡ã‚Œã¾ã™ã€‚'; const withD = `${angleToClock(p.ang)}ã€${p.dist? (Math.max(0.5,p.dist).toFixed(1)+'ãƒ¡ãƒ¼ãƒˆãƒ«ã€') : ''}${msg}`; sayThrottle('tl_'+col, withD, 2400); } }catch(e){}
    }

    // è¿‘ã„é †ã«ä¸Šä½Kä»¶ã ã‘èª­ã¿ä¸Šã’ï¼ˆå¯¾è±¡ã‚¯ãƒ©ã‚¹ã®ã¿ï¼‰
    if(said<K && allow(p.class)){
      const distSay = p.dist? `${Math.max(0.5,p.dist).toFixed(1)}ãƒ¡ãƒ¼ãƒˆãƒ«` : '';
      // å±é™ºåŸŸï¼ˆè‡³è¿‘è·é›¢ï¼‰ãªã‚‰èªå½™ã‚’å¢—ã‚„ã™
      const hazard = (p.class==='person'||p.class==='car'||p.class==='bicycle'||p.class==='bus') && (p.dist && p.dist < 1.2);
      const extra = hazard ? ' æ³¨æ„ã€æ¥è¿‘ã—ã¦ã„ã¾ã™ã€‚' : '';
      const t = `${angleToClock(p.ang)}ã€${distSay? distSay+'ã€' : ''}${toJa(p.class)}ã€‚${extra}`;
      sayThrottle(`obj_${p.class}_${tagDir}`, t, hazard? 1300: 1700);
      said++;
    }
  });
}

async function detLoop(){ if(!document.getElementById('detectOn').checked || !model){ ctx.clearRect(0,0,ov.width,ov.height); return; } try{ const preds=await model.detect(v); drawDetections(preds); }catch(e){ console.warn(e); } detTimer=setTimeout(detLoop, 600); }

// FOVã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼šå³æ™‚åæ˜ ï¼†ç°¡æ˜“é€šçŸ¥
const fovEl=document.getElementById('fov');
fovEl.addEventListener('input',()=>{ toast('FOV '+fovEl.value+'Â°'); sayThrottle('fov_notice','è·é›¢è£œæ­£ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚',1200); if(model) { model.detect(v).then(drawDetections).catch(()=>{}); } });

// ==== Boot
const gateBtn=document.getElementById('gateStart');
async function startAll(){
  document.getElementById('gate').style.display='none';
  await startCamera();
  toast('ğŸ“¦ ãƒ¢ãƒ‡ãƒ«èª­è¾¼ä¸­â€¦');
  const ok = await loadModelWithFallback();
  if(ok){ toast('âœ… æº–å‚™å®Œäº†'); detLoop(); }
  else { toast('âš  ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸å¯ï¼šã‚«ãƒ¡ãƒ©ã®ã¿å‹•ä½œï¼ˆãƒãƒƒãƒˆ/CDNã‚’ç¢ºèªï¼‰'); }
}
const gateBtn=document.getElementById('gateStart');
gateBtn.onclick = ()=>{ startAll().catch(e=>console.error(e)); };
const startBtn=document.getElementById('startBtn');
if(startBtn){ startBtn.onclick = ()=>{ startAll().catch(e=>console.error(e)); }; }
</script>
</body>
</html>
