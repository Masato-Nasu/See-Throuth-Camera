<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>視覚支援AR：方向（時計）、距離、物体を日本語で読み上げ</title>
  <meta name="description" content="最も近い対象を優先し、時計方向・距離・物体名を日本語で読み上げます。信号機の赤/青も対応。ラベルは大きく日本語で表示し、切れないよう自動調整。" />
  <!-- 正しいCDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.19.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  <style>
    :root{ --green:#39ff14; --text:#e8ffe8; }
    html,body{ margin:0; height:100%; background:#000; color:var(--text); font-family:ui-monospace,Menlo,Consolas,monospace; overflow:hidden }
    #wrap{ position:fixed; inset:0; }
    video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover }
    canvas{ position:absolute; inset:0; pointer-events:none }
    #controls{ position:fixed; left:0; right:0; bottom:0; display:flex; flex-wrap:wrap; gap:10px; padding:8px calc(10px + env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) calc(10px + env(safe-area-inset-left)); background:rgba(0,0,0,0.15); border-top:1px solid rgba(57,255,20,.25); overflow-x:auto; -webkit-overflow-scrolling:touch; z-index:5 }
    .label{ color:var(--green); font-size:12px; margin:0 4px }
    .range, select, .btn{ border:1px solid rgba(57,255,20,.45); background:rgba(0,0,0,.25); color:var(--text); border-radius:10px; padding:6px 10px; white-space:nowrap }
    .btn{ cursor:pointer }
    #gate{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.9); color:var(--text); z-index:10; text-align:center; gap:14px; padding:20px }
    #toast{ position:fixed; left:50%; transform:translateX(-50%); top:10px; padding:8px 12px; border:1px solid rgba(57,255,20,.5); border-radius:10px; background:rgba(0,0,0,.55); color:var(--green); display:none; z-index:20 }
  </style>
  <link rel="icon" href="data:," />
</head>
<body>
  <div id="toast"></div>
  <div id="wrap">
    <video id="v" autoplay playsinline muted></video>
    <canvas id="ov"></canvas>
  </div>
  <div id="controls">
    <button class="btn" id="startBtn">▶︎ 開始</button>
    <span class="label">検出</span><input id="detectOn" type="checkbox" checked />
    <span class="label">FOV°</span><input class="range" id="fov" type="range" min="45" max="85" value="60" />
    <span class="label">読み上げ</span>
    <select id="announceMode">
      <option value="important">重要のみ（人・車・自転車・バス）</option>
      <option value="people_vehicles">人＋乗り物</option>
      <option value="all">すべて</option>
    </select>
    <span class="label">最大件数</span><input class="range" id="topK" type="range" min="1" max="3" value="1" />
  </div>
  <div id="gate">
    <div>
      <h2 style="color:#39ff14;margin:0 0 6px">カメラへのアクセスが必要です</h2>
      <p style="margin:0 0 12px">HTTPSで開いてください。開始で背面カメラ＋HUDが起動します。</p>
      <button class="btn" id="gateStart">開始 / START</button>
    </div>
  </div>

<script>
(async()=>{
const v=document.getElementById('v');
const ov=document.getElementById('ov');
const ctx=ov.getContext('2d');
const toast=(m)=>{ const t=document.getElementById('toast'); t.textContent=m; t.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>t.style.display='none', 2400); }; 
console.log('[A11yAR] boot');
let model=null, detTimer=null;

async function loadModelWithFallback(){
  try{ model=await cocoSsd.load({base:'lite_mobilenet_v2'}); return true; }
  catch(e1){ console.warn('[A11yAR] coco-ssd load failed (primary)', e1);
    try{
      await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://unpkg.com/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
      model=await cocoSsd.load({base:'lite_mobilenet_v2'}); return true;
    }catch(e2){ console.warn('[A11yAR] coco-ssd load failed (fallback)', e2); return false; }
  }
}

async function startCamera(){
  if(!window.isSecureContext && location.hostname!=='localhost' && location.hostname!=='127.0.0.1'){
    toast('⚠ HTTPSが必要です（または localhost）');
    throw new Error('Insecure');
  }
  try{
    const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
    v.srcObject=stream; 
    await new Promise(res=> v.onloadedmetadata=res); 
    await v.play();
    resize(); addEventListener('resize', resize);
    toast('📷 カメラ起動');
  }catch(e){ 
    console.error('[A11yAR] camera error', e); 
    toast('❌ カメラ失敗: '+e.name+': '+e.message); 
    throw e; 
  }
}

function resize(){ const w=v.videoWidth||v.clientWidth||innerWidth; const h=v.videoHeight||v.clientHeight||innerHeight; ov.width=w; ov.height=h; }

// ==== 日本語ラベル
function toJa(cls){
  const map={
    person:'人', bicycle:'自転車', car:'車', motorcycle:'バイク', airplane:'飛行機', bus:'バス', train:'電車', truck:'トラック', boat:'ボート',
    'traffic light':'信号', 'fire hydrant':'消火栓', 'stop sign':'一時停止標識', 'parking meter':'パーキングメーター', bench:'ベンチ',
    bird:'鳥', cat:'猫', dog:'犬', horse:'馬', sheep:'羊', cow:'牛', elephant:'象', bear:'熊', zebra:'シマウマ', giraffe:'キリン',
    backpack:'リュック', umbrella:'傘', handbag:'ハンドバッグ', tie:'ネクタイ', suitcase:'スーツケース',
    frisbee:'フリスビー', skis:'スキー板', snowboard:'スノーボード', 'sports ball':'ボール', kite:'凧', 'baseball bat':'バット', 'baseball glove':'グローブ', skateboard:'スケートボード', surfboard:'サーフボード', 'tennis racket':'テニスラケット',
    bottle:'ボトル', 'wine glass':'ワイングラス', cup:'カップ', fork:'フォーク', knife:'ナイフ', spoon:'スプーン', bowl:'ボウル',
    banana:'バナナ', apple:'りんご', sandwich:'サンドイッチ', orange:'オレンジ', broccoli:'ブロッコリー', carrot:'にんじん', 'hot dog':'ホットドッグ', pizza:'ピザ', donut:'ドーナツ', cake:'ケーキ',
    chair:'椅子', couch:'ソファ', 'potted plant':'観葉植物', bed:'ベッド', 'dining table':'ダイニングテーブル', toilet:'トイレ',
    tv:'テレビ', laptop:'ノートPC', mouse:'マウス', remote:'リモコン', keyboard:'キーボード', 'cell phone':'スマホ',
    microwave:'電子レンジ', oven:'オーブン', toaster:'トースター', sink:'流し台', refrigerator:'冷蔵庫',
    book:'本', clock:'時計', vase:'花瓶', scissors:'はさみ', 'teddy bear':'ぬいぐるみ', 'hair drier':'ドライヤー', toothbrush:'歯ブラシ'
  };
  return map[cls]||cls;
}

// 以降の処理（角度→時計、距離推定、信号検知、音声合成、描画、detLoop、startAll）
// はユーザーのオリジナルコードと同じでOK。重複・エラー部分は上記で修正済み。
})();
</script>
</body>
</html>
